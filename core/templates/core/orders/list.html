{% extends 'base.html' %}

{% block title %}Заказы - Image Analysis Service{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-shopping-cart"></i> Мои заказы</h1>
        <p>Управление заказами на анализ документов</p>
    </div>

    <div class="orders-layout">
        <!-- Cart Sidebar -->
        <div class="cart-sidebar">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-cart"></i> Корзина</h3>
            </div>
            <div class="cart-items" id="cartItems">
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Корзина пуста</p>
                </div>
            </div>
            <div class="cart-total" id="cartTotal" style="display: none;">
                <div class="total-line">
                    <span>Итого:</span>
                    <span id="totalAmount">$0.00</span>
                </div>
                <button class="btn btn-primary btn-checkout" id="checkoutBtn" disabled>
                    Оформить заказ
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="orders-content">
            <div class="orders-tabs">
                <button class="tab-btn active" data-tab="documents">Документы</button>
                <button class="tab-btn" data-tab="pricing">Услуги</button>
                <button class="tab-btn" data-tab="orders">История заказов</button>
            </div>

            <!-- Documents Tab -->
            <div class="tab-content active" id="documentsTab">
                <div class="tab-header">
                    <h3>Доступные документы</h3>
                    <a href="{% url 'documents' %}" class="btn btn-outline">
                        <i class="fas fa-upload"></i> Загрузить новые
                    </a>
                </div>
                <div class="documents-grid" id="documentsGrid">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка документов...
                    </div>
                </div>
            </div>

            <!-- Pricing Tab -->
            <div class="tab-content" id="pricingTab">
                <div class="pricing-grid" id="pricingGrid">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка услуг...
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div class="tab-content" id="ordersTab">
                <div class="orders-list" id="ordersList">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка заказов...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Modal -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="orderModalContent">
            <!-- Order details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let cart = [];
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const totalAmount = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');

    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');

            // Load content if needed
            if (this.dataset.tab === 'documents' && document.getElementById('documentsGrid').children.length === 1) {
                loadDocuments();
            } else if (this.dataset.tab === 'pricing' && document.getElementById('pricingGrid').children.length === 1) {
                loadPricing();
            } else if (this.dataset.tab === 'orders' && document.getElementById('ordersList').children.length === 1) {
                loadOrders();
            }
        });
    });

    // Cart functionality
    function addToCart(documentId, documentName, pricingId, serviceName, price) {
        const existingItem = cart.find(item => item.documentId === documentId && item.pricingId === pricingId);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                documentId: documentId,
                documentName: documentName,
                pricingId: pricingId,
                serviceName: serviceName,
                price: parseFloat(price),
                quantity: 1
            });
        }

        updateCartDisplay();
    }

    function removeFromCart(documentId, pricingId) {
        cart = cart.filter(item => !(item.documentId === documentId && item.pricingId === pricingId));
        updateCartDisplay();
    }

    function updateCartDisplay() {
        if (cart.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Корзина пуста</p>
                </div>
            `;
            cartTotal.style.display = 'none';
            checkoutBtn.disabled = true;
            return;
        }

        let total = 0;
        cartItems.innerHTML = '';

        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.documentName}</div>
                    <div class="cart-item-service">${item.serviceName}</div>
                    <div class="cart-item-price">$${item.price.toFixed(2)} × ${item.quantity}</div>
                </div>
                <div class="cart-item-total">$${itemTotal.toFixed(2)}</div>
                <button class="btn-remove" onclick="removeCartItem(${item.documentId}, ${item.pricingId})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            cartItems.appendChild(cartItem);
        });

        totalAmount.textContent = `$${total.toFixed(2)}`;
        cartTotal.style.display = 'block';
        checkoutBtn.disabled = false;
    }

    // Checkout functionality
    checkoutBtn.addEventListener('click', function() {
        if (cart.length === 0) return;

        const orderData = cart.map(item => ({
            document: item.documentId,
            pricing: item.pricingId
        }));

        checkoutBtn.disabled = true;
        checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработка...';

        // Create orders for each cart item
        const orderPromises = orderData.map(item =>
            fetch('/api/orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(item)
            })
        );

        Promise.all(orderPromises)
            .then(responses => {
                const failedOrders = responses.filter(response => !response.ok);
                if (failedOrders.length > 0) {
                    throw new Error('Some orders failed to create');
                }
                return Promise.all(responses.map(r => r.json()));
            })
            .then(orders => {
                // Clear cart
                cart = [];
                updateCartDisplay();

                // Show success message
                showMessage('Заказы успешно созданы!', 'success');

                // Switch to orders tab and reload
                document.querySelector('[data-tab="orders"]').click();
                loadOrders();
            })
            .catch(error => {
                console.error('Checkout error:', error);
                showMessage('Ошибка при создании заказов', 'error');
            })
            .finally(() => {
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = 'Оформить заказ';
            });
    });

    // Load documents
    function loadDocuments() {
        fetch('/api/documents/')
            .then(response => response.json())
            .then(documents => {
                const grid = document.getElementById('documentsGrid');

                if (documents.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file"></i>
                            <p>Нет доступных документов</p>
                            <a href="{% url 'documents' %}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Загрузить документы
                            </a>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = documents.map(doc => `
                    <div class="document-select-card" data-id="${doc.id}">
                        <div class="doc-preview">
                            <i class="fas ${getFileIcon(doc.file_type)}"></i>
                        </div>
                        <div class="doc-info">
                            <h4 class="doc-title">${doc.original_name}</h4>
                            <div class="doc-meta">
                                <span class="doc-type">${getTypeText(doc.file_type)}</span>
                                <span class="doc-size">${formatFileSize(doc.size)}</span>
                                <span class="doc-status ${doc.status}">${getStatusText(doc.status)}</span>
                            </div>
                        </div>
                        <div class="doc-actions">
                            <button class="btn btn-outline btn-select" onclick="showPricingOptions(${doc.id}, '${doc.original_name}')">
                                <i class="fas fa-cart-plus"></i> Выбрать услугу
                            </button>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                document.getElementById('documentsGrid').innerHTML = '<p class="error-message">Ошибка загрузки документов</p>';
            });
    }

    // Load pricing
    function loadPricing() {
        fetch('/api/pricing/')
            .then(response => response.json())
            .then(pricing => {
                const grid = document.getElementById('pricingGrid');

                grid.innerHTML = pricing.map(service => `
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <h3>${service.service_name}</h3>
                            <div class="price">$${service.price_per_unit}</div>
                        </div>
                        <div class="pricing-description">
                            <p>${service.description || 'Описание услуги'}</p>
                        </div>
                        <div class="pricing-meta">
                            <span class="unit-type">за ${service.unit_type}</span>
                            ${service.is_active ?
                                '<span class="status active">Доступно</span>' :
                                '<span class="status inactive">Недоступно</span>'
                            }
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading pricing:', error);
                document.getElementById('pricingGrid').innerHTML = '<p class="error-message">Ошибка загрузки услуг</p>';
            });
    }

    // Load orders
    function loadOrders() {
        fetch('/api/orders/')
            .then(response => response.json())
            .then(orders => {
                const list = document.getElementById('ordersList');

                if (orders.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>У вас пока нет заказов</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = orders.map(order => `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-info">
                                <h4>Заказ #${order.id}</h4>
                                <span class="order-date">${new Date(order.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="order-status ${order.status}">
                                ${getOrderStatusText(order.status)}
                            </div>
                        </div>
                        <div class="order-details">
                            <div class="order-document">
                                <strong>Документ:</strong> ${order.document_name}
                            </div>
                            <div class="order-service">
                                <strong>Услуга:</strong> ${order.service_name}
                            </div>
                            <div class="order-total">
                                <strong>Стоимость:</strong> $${order.total_price}
                            </div>
                        </div>
                        <div class="order-actions">
                            <button class="btn btn-outline" onclick="viewOrderDetails(${order.id})">
                                <i class="fas fa-eye"></i> Подробнее
                            </button>
                            ${order.status === 'pending' || order.status === 'processing' ? `
                            <button class="btn btn-outline" onclick="cancelOrder(${order.id})">
                                <i class="fas fa-times"></i> Отменить
                            </button>
                            ` : ''}
                            ${order.status === 'completed' && order.external_order_data ? `
                            <button class="btn btn-primary" onclick="downloadResults(${order.id})">
                                <i class="fas fa-download"></i> Результаты
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = '<p class="error-message">Ошибка загрузки заказов</p>';
            });
    }

    // Global functions
    window.showPricingOptions = function(documentId, documentName) {
        fetch('/api/pricing/')
            .then(response => response.json())
            .then(pricing => {
                const modal = document.getElementById('orderModal');
                const modalContent = document.getElementById('orderModalContent');

                modalContent.innerHTML = `
                    <h2>Выберите услугу для документа</h2>
                    <p><strong>Документ:</strong> ${documentName}</p>
                    <div class="pricing-options">
                        ${pricing.map(service => `
                            <div class="pricing-option ${!service.is_active ? 'disabled' : ''}">
                                <div class="option-header">
                                    <h4>${service.service_name}</h4>
                                    <div class="option-price">$${service.price_per_unit}</div>
                                </div>
                                <div class="option-description">
                                    <p>${service.description || 'Описание услуги'}</p>
                                    <small>Единица измерения: ${service.unit_type}</small>
                                </div>
                                <div class="option-actions">
                                    ${service.is_active ? `
                                    <button class="btn btn-primary"
                                            onclick="addToCartWithPricing(${documentId}, '${documentName}', ${service.id}, '${service.service_name}', '${service.price_per_unit}')">
                                        <i class="fas fa-cart-plus"></i> Добавить в корзину
                                    </button>
                                    ` : `
                                    <button class="btn btn-outline" disabled>
                                        Недоступно
                                    </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading pricing options:', error);
            });
    };

    window.addToCartWithPricing = function(documentId, documentName, pricingId, serviceName, price) {
        addToCart(documentId, documentName, pricingId, serviceName, price);
        document.getElementById('orderModal').style.display = 'none';
        showMessage('Услуга добавлена в корзину', 'success');
    };

    window.removeCartItem = function(documentId, pricingId) {
        removeFromCart(documentId, pricingId);
    };

    window.viewOrderDetails = function(orderId) {
        fetch(`/api/orders/${orderId}/`)
            .then(response => response.json())
            .then(order => {
                const modal = document.getElementById('orderModal');
                const modalContent = document.getElementById('orderModalContent');

                modalContent.innerHTML = `
                    <h2>Детали заказа #${order.id}</h2>
                    <div class="order-details-modal">
                        <div class="detail-row">
                            <strong>Статус:</strong>
                            <span class="order-status ${order.status}">${getOrderStatusText(order.status)}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Документ:</strong>
                            <span>${order.document_name}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Услуга:</strong>
                            <span>${order.service_name}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Стоимость:</strong>
                            <span>$${order.total_price}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Создан:</strong>
                            <span>${new Date(order.created_at).toLocaleString()}</span>
                        </div>
                        ${order.completed_at ? `
                        <div class="detail-row">
                            <strong>Завершен:</strong>
                            <span>${new Date(order.completed_at).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                    ${order.external_order_data ? `
                    <div class="order-results">
                        <h3>Результаты анализа</h3>
                        <pre>${JSON.stringify(order.external_order_data, null, 2)}</pre>
                    </div>
                    ` : ''}
                    <div class="modal-actions">
                        <button class="btn btn-outline" onclick="syncOrderStatus(${order.id})">
                            <i class="fas fa-sync"></i> Обновить статус
                        </button>
                        ${order.status === 'pending' || order.status === 'processing' ? `
                        <button class="btn btn-danger" onclick="cancelOrder(${order.id})">
                            <i class="fas fa-times"></i> Отменить заказ
                        </button>
                        ` : ''}
                    </div>
                `;
                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading order details:', error);
            });
    };

    window.syncOrderStatus = function(orderId) {
        fetch(`/api/orders/${orderId}/sync_status/`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showMessage('Статус заказа обновляется', 'success');
                // Reload orders after a delay
                setTimeout(loadOrders, 2000);
            })
            .catch(error => {
                console.error('Error syncing order status:', error);
                showMessage('Ошибка обновления статуса', 'error');
            });
    };

    window.cancelOrder = function(orderId) {
        if (!confirm('Вы уверены, что хотите отменить этот заказ?')) return;

        fetch(`/api/orders/${orderId}/cancel/`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showMessage('Заказ отменен', 'success');
                loadOrders();
                document.getElementById('orderModal').style.display = 'none';
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                showMessage('Ошибка отмены заказа', 'error');
            });
    };

    window.downloadResults = function(orderId) {
        fetch(`/api/orders/${orderId}/results/`)
            .then(response => response.json())
            .then(results => {
                // Create and download a JSON file with results
                const dataStr = JSON.stringify(results, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `order-${orderId}-results.json`;
                link.click();
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error downloading results:', error);
                showMessage('Ошибка загрузки результатов', 'error');
            });
    };

    function getOrderStatusText(status) {
        const statusTexts = {
            'pending': 'Ожидание',
            'processing': 'В обработке',
            'completed': 'Завершен',
            'cancelled': 'Отменен'
        };
        return statusTexts[status] || status;
    }

    function showMessage(message, type) {
        // Simple message display - you might want to use a more sophisticated notification system
        alert(`${type === 'success' ? '✓' : '✗'} ${message}`);
    }

    // Modal close functionality
    document.querySelector('#orderModal .close').addEventListener('click', function() {
        document.getElementById('orderModal').style.display = 'none';
    });

    // Initial load
    loadDocuments();
});
</script>
{% endblock %}