{% extends 'base.html' %}

{% block title %}Галерея - Image Analysis Service{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-images"></i> Галерея изображений</h1>
        <p>Просмотр и управление обработанными изображениями</p>
    </div>

    <div class="gallery-controls">
        <div class="filters">
            <select id="filterType" class="filter-select">
                <option value="">Все типы</option>
                <option value="image">Изображения</option>
                <option value="pdf">PDF</option>
                <option value="text">Текстовые</option>
            </select>

            <select id="filterStatus" class="filter-select">
                <option value="">Все статусы</option>
                <option value="completed">Завершено</option>
                <option value="processing">В обработке</option>
                <option value="uploaded">Загружено</option>
            </select>

            <input type="text" id="searchInput" placeholder="Поиск по названию..." class="search-input">
        </div>

        <div class="view-controls">
            <button id="gridView" class="view-btn active"><i class="fas fa-th"></i></button>
            <button id="listView" class="view-btn"><i class="fas fa-list"></i></button>
        </div>
    </div>

    <div class="gallery-stats">
        <div class="stat-item">
            <span class="stat-number" id="totalCount">0</span>
            <span class="stat-label">Всего документов</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="completedCount">0</span>
            <span class="stat-label">Обработано</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="imagesCount">0</span>
            <span class="stat-label">Изображений</span>
        </div>
    </div>

    <div class="gallery-container grid-view" id="galleryContainer">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Загрузка документов...
        </div>
    </div>

    <div class="pagination" id="pagination">
        <!-- Pagination will be generated by JavaScript -->
    </div>
</div>

<!-- Document Modal -->
<div id="documentModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalContent">
            <!-- Modal content will be loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentType = '';
    let currentStatus = '';
    let currentSearch = '';
    const pageSize = 12;

    const galleryContainer = document.getElementById('galleryContainer');
    const pagination = document.getElementById('pagination');
    const modal = document.getElementById('documentModal');
    const closeModal = document.querySelector('.close');

    // View controls
    document.getElementById('gridView').addEventListener('click', function() {
        galleryContainer.className = 'gallery-container grid-view';
        this.classList.add('active');
        document.getElementById('listView').classList.remove('active');
    });

    document.getElementById('listView').addEventListener('click', function() {
        galleryContainer.className = 'gallery-container list-view';
        this.classList.add('active');
        document.getElementById('gridView').classList.remove('active');
    });

    // Filter handlers
    document.getElementById('filterType').addEventListener('change', function() {
        currentType = this.value;
        currentPage = 1;
        loadDocuments();
    });

    document.getElementById('filterStatus').addEventListener('change', function() {
        currentStatus = this.value;
        currentPage = 1;
        loadDocuments();
    });

    document.getElementById('searchInput').addEventListener('input', function() {
        currentSearch = this.value;
        currentPage = 1;
        loadDocuments();
    });

    // Modal handlers
    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    function loadDocuments() {
        let url = `/api/documents/?page=${currentPage}&page_size=${pageSize}`;

        if (currentType) url += `&file_type=${currentType}`;
        if (currentStatus) url += `&status=${currentStatus}`;
        if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;

        galleryContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayDocuments(data.results || data);
                updatePagination(data);
                updateStats(data);
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                galleryContainer.innerHTML = '<p class="error-message">Ошибка загрузки документов</p>';
            });
    }

    function displayDocuments(documents) {
        if (documents.length === 0) {
            galleryContainer.innerHTML = '<p class="no-documents">Документы не найдены</p>';
            return;
        }

        galleryContainer.innerHTML = documents.map(doc => `
            <div class="document-card" data-id="${doc.id}">
                <div class="doc-preview">
                    ${getDocumentPreview(doc)}
                    <div class="doc-overlay">
                        <button class="btn-view" onclick="openDocumentModal(${doc.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${doc.analysis_result ? `
                        <button class="btn-results" onclick="viewAnalysisResults(${doc.id})">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        ` : ''}
                    </div>
                    <div class="doc-status ${doc.status}">${getStatusText(doc.status)}</div>
                </div>
                <div class="doc-info">
                    <h4 class="doc-title">${doc.original_name}</h4>
                    <div class="doc-meta">
                        <span class="doc-type"><i class="fas ${getFileIcon(doc.file_type)}"></i> ${getTypeText(doc.file_type)}</span>
                        <span class="doc-size">${formatFileSize(doc.size)}</span>
                        <span class="doc-date">${new Date(doc.uploaded_at).toLocaleDateString()}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function getDocumentPreview(doc) {
        if (doc.file_type === 'image') {
            return `<img src="/api/documents/${doc.id}/preview/" alt="${doc.original_name}"
                     onerror="this.src='{% static 'images/placeholder.jpg' %}'">`;
        } else {
            return `<div class="file-preview ${doc.file_type}">
                        <i class="fas ${getFileIcon(doc.file_type)}"></i>
                        <span>${doc.file_type.toUpperCase()}</span>
                    </div>`;
        }
    }

    function updatePagination(data) {
        if (!data.count || data.count <= pageSize) {
            pagination.innerHTML = '';
            return;
        }

        const totalPages = Math.ceil(data.count / pageSize);
        let paginationHTML = '';

        if (currentPage > 1) {
            paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">
                                <i class="fas fa-chevron-left"></i> Назад
                              </button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<span class="page-current">${i}</span>`;
            } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                paginationHTML += '<span class="page-ellipsis">...</span>';
            }
        }

        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">
                                Вперед <i class="fas fa-chevron-right"></i>
                              </button>`;
        }

        pagination.innerHTML = paginationHTML;
    }

    function updateStats(data) {
        document.getElementById('totalCount').textContent = data.count || data.length;

        // These would need additional API endpoints or client-side calculation
        const completed = data.results ? data.results.filter(d => d.status === 'completed').length : 0;
        const images = data.results ? data.results.filter(d => d.file_type === 'image').length : 0;

        document.getElementById('completedCount').textContent = completed;
        document.getElementById('imagesCount').textContent = images;
    }

    function getTypeText(fileType) {
        const types = {
            'image': 'Изображение',
            'pdf': 'PDF',
            'text': 'Текст',
            'other': 'Файл'
        };
        return types[fileType] || fileType;
    }

    // Global functions for event handlers
    window.changePage = function(page) {
        currentPage = page;
        loadDocuments();
    };

    window.openDocumentModal = function(docId) {
        fetch(`/api/documents/${docId}/`)
            .then(response => response.json())
            .then(doc => {
                document.getElementById('modalContent').innerHTML = `
                    <h2>${doc.original_name}</h2>
                    <div class="modal-details">
                        <p><strong>Тип:</strong> ${getTypeText(doc.file_type)}</p>
                        <p><strong>Размер:</strong> ${formatFileSize(doc.size)}</p>
                        <p><strong>Статус:</strong> <span class="doc-status ${doc.status}">${getStatusText(doc.status)}</span></p>
                        <p><strong>Загружено:</strong> ${new Date(doc.uploaded_at).toLocaleString()}</p>
                        ${doc.processed_at ? `<p><strong>Обработано:</strong> ${new Date(doc.processed_at).toLocaleString()}</p>` : ''}
                    </div>
                    ${doc.analysis_result ? `
                    <div class="analysis-results">
                        <h3>Результаты анализа</h3>
                        <pre>${JSON.stringify(doc.analysis_result, null, 2)}</pre>
                    </div>
                    ` : ''}
                `;
                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading document details:', error);
            });
    };

    window.viewAnalysisResults = function(docId) {
        fetch(`/api/documents/${docId}/analysis_results/`)
            .then(response => response.json())
            .then(results => {
                document.getElementById('modalContent').innerHTML = `
                    <h2>Результаты анализа</h2>
                    <div class="analysis-details">
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    </div>
                `;
                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading analysis results:', error);
            });
    };

    // Initial load
    loadDocuments();
});
</script>
{% endblock %}